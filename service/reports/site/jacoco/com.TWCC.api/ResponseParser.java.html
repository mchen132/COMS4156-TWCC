<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResponseParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">nyc-todo-service</a> &gt; <a href="index.source.html" class="el_package">com.TWCC.api</a> &gt; <span class="el_source">ResponseParser.java</span></div><h1>ResponseParser.java</h1><pre class="source lang-java linenums">package com.TWCC.api;

import com.TWCC.data.Event;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.node.BooleanNode;
import com.fasterxml.jackson.databind.node.DoubleNode;
import com.fasterxml.jackson.databind.node.TextNode;
import java.sql.Timestamp;
import java.time.Instant;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.stream.Collectors;
import org.springframework.stereotype.Component;

@Component
<span class="fc" id="L22">public class ResponseParser {</span>

<span class="fc" id="L24">    private ObjectMapper mapper = new ObjectMapper();</span>
    private static final int LEGAL_AGE = 18;

    /**
     * convert a ticketmaster events JSON response to a list of events
     *
     * @param jsonString
     * @return List&lt;Event&gt; a list of events
     */
    public List&lt;Event&gt; processResponse(String jsonString) {
<span class="fc" id="L34">        Map&lt;String, Object&gt; responseMap = this.jsonStringToMap(jsonString);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L37">        Map&lt;String, Object&gt; eventMap =</span>
<span class="fc" id="L38">            (HashMap&lt;String, Object&gt;) responseMap.get(&quot;_embedded&quot;);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L41">        ArrayList&lt;Object&gt; eventList = (ArrayList&lt;Object&gt;) eventMap.get(</span>
            &quot;events&quot;
        );

<span class="fc" id="L45">        return objectListToEventList(eventList);</span>
    }

    /**
     * convert a list of Objects to a list of Event objects
     *
     * @param objList
     * @return List&lt;Event&gt; a list of events
     */
    private List&lt;Event&gt; objectListToEventList(List&lt;Object&gt; objList) {
<span class="fc" id="L55">        return objList</span>
<span class="fc" id="L56">            .stream()</span>
<span class="fc" id="L57">            .map(this::objectToEvent)</span>
<span class="fc" id="L58">            .collect(Collectors.toList());</span>
    }

    /**
     * convert an hash map that is cast to an Object, to an Event object
     *
     * @param obj
     * @return an Event object
     */
    private Event objectToEvent(Object obj) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L69">        Map&lt;String, Object&gt; eventMap = (HashMap&lt;String, Object&gt;) obj;</span>

<span class="fc" id="L71">        int id = -1;</span>
<span class="fc" id="L72">        String address = this.extractAddress(eventMap);</span>

<span class="fc" id="L74">        int ageLimit = this.extractAgeLimit(eventMap);</span>

<span class="fc" id="L76">        String name = String.valueOf(eventMap.get(&quot;name&quot;));</span>

        // remove surrounding double-quotes
<span class="fc" id="L79">        name = name.substring(1, name.length() - 1);</span>

        // ticketmater event API does not have description field
<span class="fc" id="L82">        String description = name;</span>

<span class="fc" id="L84">        List&lt;Double&gt; locationPair = this.extractCoordinates(eventMap);</span>

<span class="fc" id="L86">        double longitude = locationPair.get(0).doubleValue();</span>
<span class="fc" id="L87">        double latitude = locationPair.get(1).doubleValue();</span>

<span class="fc" id="L89">        float cost = this.extractCost(eventMap);</span>

<span class="fc" id="L91">        String media = String.valueOf(eventMap.get(&quot;url&quot;));</span>

        // Remove surrounding double-quotes
<span class="fc" id="L94">        media = media.substring(1, media.length() - 1);</span>

        // Ticketmaster API does not provide event end time and creation time
<span class="fc" id="L97">        Timestamp startTimestamp = this.extractStartTimestamp(eventMap);</span>
<span class="fc" id="L98">        Timestamp creationTimestamp = startTimestamp;</span>
<span class="fc" id="L99">        Timestamp endTimestamp = startTimestamp;</span>

<span class="fc" id="L101">        return new Event(</span>
            id,
            address,
            ageLimit,
            name,
            description,
            longitude,
            latitude,
            cost,
            media,
            -1,
            &quot;testCategory&quot;,
            creationTimestamp,
            startTimestamp,
            endTimestamp
        );
    }

    /**
     * extract the &quot;venues&quot; attribue from JSON response
     *
     * @param eventMap
     * @return Map&lt;String, Object&gt; of the value of the &quot;venues&quot; attribue
     *         from JSON response
     */
    private Map&lt;String, Object&gt; extractVenueMap(Map&lt;String, Object&gt; eventMap) {
        // All location related info are embedded in events[_embedded][venues]
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L129">        Map&lt;String, Object&gt; venueMap = (HashMap&lt;String, Object&gt;) (</span>
            (ArrayList&lt;Object&gt;) (
<span class="fc" id="L131">                (HashMap&lt;String, Object&gt;) eventMap.get(&quot;_embedded&quot;)</span>
<span class="fc" id="L132">            ).get(&quot;venues&quot;)</span>
<span class="fc" id="L133">        ).get(0);</span>

<span class="fc" id="L135">        return venueMap;</span>
    }

    /**
     * extract venue location coordinates
     *
     * @param eventMap
     * @return List&lt;Double&gt; where list[0]=longitude, list[1]=latitude
     */
    private List&lt;Double&gt; extractCoordinates(Map&lt;String, Object&gt; eventMap) {
<span class="fc" id="L145">        List&lt;Double&gt; res = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L147">        Map&lt;String, Object&gt; venueMap = this.extractVenueMap(eventMap);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L150">        Map&lt;String, Object&gt; locationMap =</span>
<span class="fc" id="L151">            (HashMap&lt;String, Object&gt;) venueMap.get(&quot;location&quot;);</span>

<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (locationMap != null) {</span>
<span class="fc" id="L154">            String longitudeString =</span>
<span class="fc" id="L155">                ((TextNode) locationMap.get(&quot;longitude&quot;)).toString();</span>

            // remove surrounding quotes
<span class="fc" id="L158">            longitudeString =</span>
<span class="fc" id="L159">                longitudeString.substring(1, longitudeString.length() - 1);</span>

<span class="fc" id="L161">            String latitudeString =</span>
<span class="fc" id="L162">                ((TextNode) locationMap.get(&quot;latitude&quot;)).toString();</span>

            // remove surrounding quotes
<span class="fc" id="L165">            latitudeString =</span>
<span class="fc" id="L166">                latitudeString.substring(1, latitudeString.length() - 1);</span>

<span class="fc" id="L168">            res.add(Double.valueOf(longitudeString));</span>
<span class="fc" id="L169">            res.add(Double.valueOf(latitudeString));</span>
<span class="fc" id="L170">        } else {</span>
            // set coordinates to 0 if the event doesn't have a venue

<span class="fc" id="L173">            res.add(Double.valueOf(&quot;0.000000&quot;));</span>
<span class="fc" id="L174">            res.add(Double.valueOf(&quot;0.000000&quot;));</span>
        }

<span class="fc" id="L177">        return res;</span>
    }

    /**
     * extract address
     *
     * @param eventMap
     * @return String in the following format:
     *
     *         &quot;&lt;venue name&gt;, &lt;street address&gt;, &lt;city&gt;, &lt;state code&gt;, &lt;country
     *         code&gt;&quot;
     *
     *         if the event doesn't have an venue, &quot;online&quot; be returned
     */
    private String extractAddress(Map&lt;String, Object&gt; eventMap) {
<span class="fc" id="L192">        Map&lt;String, Object&gt; venueMap = this.extractVenueMap(eventMap);</span>

        // venue JSON sometimes containes only a {href: String} pair
        // which directs to another API call to get venue details.
        // venue JSON sometimes also contain the detailed information
        // about the venue.
        // Such pattern is unpredictable

<span class="fc bfc" id="L200" title="All 2 branches covered.">        if (venueMap.size() == 1) {</span>
<span class="fc" id="L201">            return &quot;online&quot;;</span>
        }

        // venue name
<span class="fc" id="L205">        String name = String.valueOf(venueMap.get(&quot;name&quot;));</span>

        // removing double quotes from the original string value
<span class="fc" id="L208">        name = name.substring(1, name.length() - 1);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L211">        Map&lt;String, Object&gt; streetAddrMap =</span>
<span class="fc" id="L212">            (HashMap&lt;String, Object&gt;) venueMap.get(&quot;address&quot;);</span>

<span class="fc" id="L214">        String streetAddr = &quot;&quot;;</span>

<span class="fc bfc" id="L216" title="All 2 branches covered.">        for (String key : streetAddrMap.keySet()) {</span>
<span class="fc" id="L217">            String addr = String.valueOf(streetAddrMap.get(key));</span>

            // removing double quotes from the original string value
<span class="fc" id="L220">            addr = &quot; &quot; + addr.substring(1, addr.length() - 1);</span>

<span class="fc" id="L222">            streetAddr += addr;</span>
<span class="fc" id="L223">        }</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L226">        String city = String.valueOf(</span>
<span class="fc" id="L227">            ((HashMap&lt;String, Object&gt;) venueMap.get(&quot;city&quot;)).get(&quot;name&quot;)</span>
        );

        // removing double quotes from the original string value
<span class="fc" id="L231">        city = city.substring(1, city.length() - 1);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L234">        String state = String.valueOf(</span>
<span class="fc" id="L235">            ((HashMap&lt;String, Object&gt;) venueMap.get(&quot;state&quot;)).get(&quot;stateCode&quot;)</span>
        );

        // removing double quotes from the original string value
<span class="fc" id="L239">        state = state.substring(1, state.length() - 1);</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L242">        String country = String.valueOf(</span>
<span class="fc" id="L243">            ((HashMap&lt;String, Object&gt;) venueMap.get(&quot;country&quot;)).get(</span>
                    &quot;countryCode&quot;
                )
        );

        // removing double quotes from the original string value
<span class="fc" id="L249">        country = country.substring(1, country.length() - 1);</span>

<span class="fc" id="L251">        return String.format(</span>
            &quot;%s,%s, %s, %s, %s&quot;,
            name,
            streetAddr,
            city,
            state,
            country
        );
    }

    /**
     * extract event start timestamp
     *
     * @param eventMap
     * @return Timestamp: the timestamp of the start time.
     *
     *         If &quot;dateTime&quot; attribute is missing, &quot;localdate 00:00:00&quot;
     *         will be used
     */
    private Timestamp extractStartTimestamp(Map&lt;String, Object&gt; eventMap) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L272">        Map&lt;String, Object&gt; startTimeMap = (HashMap&lt;String, Object&gt;) (</span>
<span class="fc" id="L273">            (HashMap&lt;String, Object&gt;) eventMap.get(&quot;dates&quot;)</span>
<span class="fc" id="L274">        ).get(&quot;start&quot;);</span>

        // start time's DateTime is missing from the response body
<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (!startTimeMap.containsKey(&quot;dateTime&quot;)) {</span>
<span class="fc" id="L278">            String localDateString = String.valueOf(</span>
<span class="fc" id="L279">                startTimeMap.get(&quot;localDate&quot;)</span>
            );

<span class="fc" id="L282">            localDateString =</span>
<span class="fc" id="L283">                localDateString.substring(1, localDateString.length() - 1);</span>

<span class="fc" id="L285">            localDateString += &quot; 00:00:00&quot;;</span>

<span class="fc" id="L287">            System.out.println(localDateString);</span>

<span class="fc" id="L289">            return Timestamp.valueOf(localDateString);</span>
        }

<span class="fc" id="L292">        String startTimestampString = String.valueOf(</span>
<span class="fc" id="L293">            startTimeMap.get(&quot;dateTime&quot;)</span>
        );

<span class="fc" id="L296">        startTimestampString =</span>
<span class="fc" id="L297">            startTimestampString.substring(</span>
                1,
<span class="fc" id="L299">                startTimestampString.length() - 1</span>
            );

<span class="fc" id="L302">        Instant dateTime = Instant.parse(startTimestampString);</span>

<span class="fc" id="L304">        return Timestamp.from(dateTime);</span>
    }

    /**
     * extract event cost
     *
     * @param eventMap
     * @return float: min event cost.
     *
     *         returns 0 if &quot;priceRanges&quot; or &quot;min&quot; attribute is missing
     */
    private float extractCost(Map&lt;String, Object&gt; eventMap) {
<span class="fc" id="L316">        float res = 0;</span>

<span class="fc bfc" id="L318" title="All 2 branches covered.">        if (eventMap.get(&quot;priceRanges&quot;) == null) {</span>
<span class="fc" id="L319">            return res;</span>
        }

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L323">        ArrayList&lt;Object&gt; rangeList = (ArrayList&lt;Object&gt;) eventMap.get(</span>
            &quot;priceRanges&quot;
        );

<span class="fc bfc" id="L327" title="All 2 branches covered.">        if (rangeList.size() == 0) {</span>
<span class="fc" id="L328">            return res;</span>
        }

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L332">        Map&lt;String, Object&gt; priceMap = (HashMap&lt;String, Object&gt;) rangeList.get(</span>
            0
        );

<span class="fc bfc" id="L336" title="All 2 branches covered.">        if (priceMap.get(&quot;min&quot;) == null) {</span>
<span class="fc" id="L337">            return res;</span>
        }

<span class="fc" id="L340">        return (float) ((DoubleNode) priceMap.get(&quot;min&quot;)).asDouble();</span>
    }

    /**
     * extract age limit
     *
     * @param eventMap
     * @return int: 0 if &quot;ageRestrictions&quot; or &quot;legalAgeEnforced&quot; attribue is
     *         missing, or
     *         &quot;legalAgeEnforced&quot; attribue is false; 18 if &quot;legalAgeEnforced&quot; is
     *         true
     */
    @SuppressWarnings(&quot;checkstyle:AvoidInlineConditionals&quot;)
    private int extractAgeLimit(Map&lt;String, Object&gt; eventMap) {
<span class="fc" id="L354">        int ageLimit = 0;</span>

<span class="fc bfc" id="L356" title="All 2 branches covered.">        if (!eventMap.containsKey(&quot;ageRestrictions&quot;)) {</span>
<span class="fc" id="L357">            return ageLimit;</span>
        }

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L361">        Map&lt;String, Object&gt; restrictionMap =</span>
<span class="fc" id="L362">            (HashMap&lt;String, Object&gt;) eventMap.get(&quot;ageRestrictions&quot;);</span>

<span class="fc bfc" id="L364" title="All 2 branches covered.">        if (!restrictionMap.containsKey(&quot;legalAgeEnforced&quot;)) {</span>
<span class="fc" id="L365">            return ageLimit;</span>
        }

<span class="fc" id="L368">        boolean ageRestriction =</span>
            (
<span class="fc" id="L370">                (BooleanNode) restrictionMap.get(&quot;legalAgeEnforced&quot;)</span>
<span class="fc" id="L371">            ).booleanValue();</span>

<span class="fc bfc" id="L373" title="All 2 branches covered.">        ageLimit = ageRestriction ? LEGAL_AGE : 0;</span>

<span class="fc" id="L375">        return ageLimit;</span>
    }

    // NOTE: stringToMap(), toMap(), and toList() are inspired by the following
    // stackoverflow post: https://stackoverflow.com/a/24012023

    /**
     * Convert a JSON string in to a Map&lt;String, Object&gt;
     *
     * @param jsonString
     * @return Map&lt;String, Object&gt;: JSON attribute names in string,
     * all values are cast to Object
     */
    private Map&lt;String, Object&gt; jsonStringToMap(String jsonString) {
<span class="fc" id="L389">        Map&lt;String, Object&gt; retMap = new HashMap&lt;&gt;();</span>

        try {
<span class="fc" id="L392">            JsonNode node = this.mapper.readTree(jsonString);</span>

<span class="pc bpc" id="L394" title="1 of 2 branches missed.">            if (node != null) {</span>
<span class="fc" id="L395">                retMap = this.toMap(node);</span>
            }

<span class="fc" id="L398">            return retMap;</span>
<span class="nc" id="L399">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L400">            e.printStackTrace();</span>
        }

<span class="nc" id="L403">        return retMap;</span>
    }

    /**
     * Convert a JsonNode tree to a Json in the form of a Map
     * where map's value are essentially JsonNode objects;
     * we can use JsonNode's own methods to check and get values
     *
     * @param rootNode
     * @return Map&lt;String, Object&gt; representing the underlying structure
     *         of the JsonNode
     */
    private Map&lt;String, Object&gt; toMap(JsonNode rootNode) {
<span class="fc" id="L416">        Map&lt;String, Object&gt; retMap = new HashMap&lt;&gt;();</span>

<span class="fc" id="L418">        Iterator&lt;Entry&lt;String, JsonNode&gt;&gt; iter = rootNode.fields();</span>

<span class="fc" id="L420">        iter.forEachRemaining(field -&gt; {</span>
<span class="fc" id="L421">            String key = field.getKey();</span>
<span class="fc" id="L422">            JsonNode currNode = field.getValue();</span>
<span class="fc" id="L423">            Object value = currNode;</span>

<span class="fc bfc" id="L425" title="All 2 branches covered.">            if (currNode.isArray()) {</span>
<span class="fc" id="L426">                value = this.toList(currNode);</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">            } else if (currNode.isObject()) {</span>
<span class="fc" id="L428">                value = this.toMap(currNode);</span>
            }

<span class="fc" id="L431">            retMap.put(key, value);</span>
<span class="fc" id="L432">        });</span>

<span class="fc" id="L434">        return retMap;</span>
    }

    /**
     * convert an Array JsonNode to a list of JsonNodes
     *
     * @param rootNode
     * @return List&lt;Object&gt; representing the underlying structure
     *         of an Array JsonNode
     */
    private List&lt;Object&gt; toList(JsonNode rootNode) {
<span class="fc" id="L445">        List&lt;Object&gt; retList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L447">        Iterator&lt;JsonNode&gt; iter = rootNode.elements();</span>

<span class="fc" id="L449">        iter.forEachRemaining(currNode -&gt; {</span>
<span class="fc" id="L450">            Object value = currNode;</span>

<span class="pc bpc" id="L452" title="1 of 2 branches missed.">            if (currNode.isObject()) {</span>
<span class="fc" id="L453">                value = this.toMap(currNode);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            } else if (currNode.isArray()) {</span>
<span class="nc" id="L455">                value = this.toList(currNode);</span>
            }

<span class="fc" id="L458">            retList.add(value);</span>
<span class="fc" id="L459">        });</span>

<span class="fc" id="L461">        return retList;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>